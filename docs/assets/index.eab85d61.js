var pe=Object.defineProperty,he=Object.defineProperties;var me=Object.getOwnPropertyDescriptors;var X=Object.getOwnPropertySymbols;var ge=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var I=(e,t,n)=>t in e?pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,T=(e,t)=>{for(var n in t||(t={}))ge.call(t,n)&&I(e,n,t[n]);if(X)for(var n of X(t))ve.call(t,n)&&I(e,n,t[n]);return e},j=(e,t)=>he(e,me(t));var M=(e,t,n)=>(I(e,typeof t!="symbol"?t+"":t,n),n);import{L as w,D as we,r as l,d as E,j as J,M as C,R as Z,B as ye,a as ee,u as xe,b as be,c as Le,e as Ee,S as Se,f as ke,g as Re,h as G}from"./vendor.ce18ed85.js";const Te=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerpolicy&&(a.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?a.credentials="include":o.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}};Te();function te(){const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}async function je(e){return w(await Promise.all(e))}function Me({path:e,root:t}){return t?"/"+e.join("/"):e.join("/")}class Oe extends we{constructor(){super("Book");M(this,"kv");M(this,"bookKeys");M(this,"books");M(this,"session");this.version(1).stores({kv:"key",bookKeys:"id",books:"id",session:"id"})}}const v=new Oe,ne=v.books,K=v.bookKeys,O=v.session;async function Ce(e){const t=await v.kv.get(e);return t==null?void 0:t.val}async function ze(e,t){await v.kv.put({key:e,val:t,timestamp:Date.now()})}const De={get:Ce,set:ze};function He(e,t){const[n,s]=l.exports.useState(void 0),o=E.exports.useLiveQuery(()=>O.get(e),[e]);return o&&(!n||o.timestamp>n.timestamp)&&(console.log("db new session",o),s(o)),l.exports.useEffect(()=>{(async()=>{if(await O.get(e)||!t)return;const r=await K.get(t);if(!r)return null;await O.put({id:e,name:r.title,size:r.size,book:t,pos:0,per:0,timestamp:0})})()},[e,t]),l.exports.useEffect(()=>{n&&(!o||n.timestamp>o.timestamp)&&O.put(n)},[n,o]),[n,s]}const Ue=(e,t)=>{const[n,s]=l.exports.useState(t),[o,a]=l.exports.useState(0),r=E.exports.useLiveQuery(()=>v.kv.get(e),[e]);r&&r.timestamp>o&&(s(r.val),a(r.timestamp)),l.exports.useEffect(()=>{v.transaction("rw",v.kv,async()=>{const d=await v.kv.get(e);(!d||d.timestamp<o)&&await v.kv.put({key:e,val:n,timestamp:o})})},[e,n]);function i(d){s(typeof d=="function"?d(n):d),a(Date.now())}return[n,o,i]},c=J.exports.jsx,z=J.exports.jsxs,{useState:U}=Z;function oe(e,t,n){const s=e.nodeName.toLowerCase(),o=a=>Me({path:t.path.concat(w(a.split("/"))),root:t.root});return{label:s=="image"?"img":s,data:s=="img"?e.src:s=="a"?e.href:s=="image"?o(e.href.baseVal):void 0,content:e.childElementCount?Array.from(e.children).map(a=>oe(a,t)):e.textContent?e.textContent:void 0}}function se(e,t){return e.map(n=>{const s=n.label,o=n.href.split("#")[0].split("?")[0];return{label:s,pos:t.get(o)||0,sub:n.subitems?se(w(n.subitems),t):void 0}}).toArray()}async function Pe(e,t){return(await je(e.map(async n=>{const s=n.href||n.url;if(s==null)return;const o={path:w(s.split("/")).pop(),root:s.length>0&&s[0]=="/"};let r=(await t.load(s)).body;for(;r.childElementCount==1&&r.firstElementChild.childElementCount;)r=r.firstElementChild;const i=Array.from(r.children).map(d=>oe(d,o));return{href:s,elem:i}}))).reduce((n,s)=>{if(!s)return n;const o=n.elem.length;return{table:n.table.set(s.href,o),elem:n.elem.concat(s.elem)}},{table:C(),elem:new Array})}async function A(e,t){if(!!e)try{const n=new URL(e);return n.host==location.host?await t(n.pathname.slice(1)):e}catch(n){return console.log(n),await t(e.split("#")[0].split("?")[0])}}async function re(e,t){let n=C();for(const s of e){if(s.label=="img"){const o=await A(s.data,async r=>r);if(!o)continue;const a=await t.archive.request(t.resolve(o),"blob");n=n.set(o,a)}typeof s.content=="object"&&(n=n.merge(await re(s.content,t)))}return n}async function ie(e,t,n){return await Promise.all(e.map(async o=>{const a=o.label=="img"?await A(o.data,async i=>i).catch(()=>o.data):o.label=="a"?await A(o.data,async i=>"pos://"+t.get(i)):void 0,r=typeof o.content=="object"?await ie(o.content,t):o.content;return j(T({},o),{data:a,content:r})}))}async function Be(e,t,n){const s=new ye;await s.open(e,"epub"),console.log(s);const o=await s.loaded.metadata,a=await s.loaded.navigation,r=await s.loaded.spine,i=await Pe(w(r.items),s),d=await ie(i.elem,i.table),g=(await re(d,s)).toObject(),D=se(w(a.toc),i.table),S=te(),y=o.title||n,H=d.length;ne.add({id:S,title:y,elem:d,menu:D,pic:g,size:H}),K.add({id:S,title:y,size:H}),t("Successfully imported "+y),t("Book ID: "+S)}function Ie(){const e=E.exports.useLiveQuery(()=>O.toArray());return c("ul",{children:e==null?void 0:e.map((t,n)=>c("li",{children:c(ee,{to:`view/${t.id}`,children:"[ "+Math.floor(t.pos/t.size*100*10)/10+"% ] -> "+t.name})},n))})}function Ae(){const e=E.exports.useLiveQuery(()=>K.toArray());return c("ul",{children:e==null?void 0:e.map((t,n)=>c("li",{children:c(ee,{to:`view/${te()}?book=${t.id}`,children:t.title})},n))})}function Ke(){const[e,t,n]=Ue("injection",""),[s,o]=U(""),[a,r]=U(0);return t>a&&(o(e),r(t)),z("div",{children:[c("textarea",{value:s,onChange:i=>o(i.target.value),style:{width:"100%",height:"20em"}}),c("br",{}),c("button",{onClick:()=>{r(Date.now()),n(s)},children:"Save"})]})}function Qe(){const[e,t]=U(w()),[n,s]=U("Sessions"),o=C({Sessions:c(Ie,{}),Books:c(Ae,{}),Injection:c(Ke,{})});l.exports.useEffect(()=>{document.title="Scrolled Reader"});const a=r=>t(i=>i.push(r));return z("div",{style:{margin:"100px auto",width:"90%",maxWidth:"650px"},children:[z("p",{style:{},children:[c("span",{children:"Import .epub: "}),c("span",{children:c("input",{title:" ",type:"file",accept:".epub",onChange:r=>{const i=r.target.files;i&&i.length>0&&Be(URL.createObjectURL(i[0]),a,i[0].name)}})})]}),c("ul",{style:{fontSize:"11px"},children:e.map((r,i)=>c("li",{children:r},i))}),c("p",{children:o.keySeq().map(r=>c("button",{onClick:()=>s(r),children:r},r))}),c("br",{}),o.get(n)]})}function _e(){const e=E.exports.useLiveQuery(()=>De.get("injection"));return l.exports.useEffect(()=>{const t=document.head.innerHTML;return e&&(document.head.innerHTML=t+e),()=>{document.head.innerHTML=t}},[e]),c("div",{style:{display:"none"}})}function ae(e,t,n,s,o){var a;return Le.createElement(e.label,{key:s,ref:o,src:e.label=="img"?t.get(e.data):void 0,href:e.label=="a"?"#":void 0,onClick:e.label=="a"?r=>{r.preventDefault(),n(parseInt(e.data.slice(6)))}:void 0},typeof e.content=="string"?e.content:(a=e.content)==null?void 0:a.map((r,i)=>ae(r,t,n,i)))}function Ne(){var F;const[e,t]=l.exports.useState(1),s=xe().id,[o,a]=be(),r=o.get("book"),[i,d]=He(s,r),g=E.exports.useLiveQuery(async()=>{if(!!i)return ne.get(i.book)},[i==null?void 0:i.book]),[D,S]=l.exports.useState(10),[y,H]=i&&g?[Math.max(0,i.pos-D),Math.min(i.pos+D,g.elem.length-1)]:[0,0],P=g?g.elem.slice(y,H+1):void 0;let x=w();const[Q,ce]=l.exports.useState(0),h=l.exports.useRef(null),_=l.exports.useRef(null),[ue,B]=l.exports.useState(0),[Fe,le]=l.exports.useState(0),[Xe,de]=l.exports.useState(0);l.exports.useEffect(()=>{function u(){le(window.innerHeight),de(window.innerWidth)}return window.addEventListener("resize",u),()=>{window.removeEventListener("resize",u)}});function N(u){let p=Math.max(0,Q+u);for(let f=0;f<x.size-1;f++){const k=x.get(f),L=x.get(f+1);if(!k||!L)return;if(p<L.offsetTop){d(R=>R&&j(T({},R),{pos:y+f,per:(p-k.offsetTop)/(L.offsetTop-k.offsetTop),timestamp:Date.now()}));return}}const m=x.last();!m||d(f=>f&&j(T({},f),{pos:y+x.size-1,per:Math.min(1,(p-m.offsetTop)/m.offsetHeight),timestamp:Date.now()}))}const fe=()=>{var L;if(!i)return;const u=i.pos-y,p=((L=_.current)==null?void 0:L.offsetHeight)||0;if(p==0)return;t(0),e==0&&p<h.current.offsetHeight*3&&S(R=>R+5);const m=x.get(u),f=x.get(u+1);if(!m)return;const k=m.offsetTop+i.per*(f?f.offsetTop-m.offsetTop:m.offsetHeight);ce(k)};l.exports.useEffect(fe);const b=l.exports.useRef({id:null,x:0,y:0});function V(u){N(u.deltaY)}function $(u){b.current.id||(B(0),b.current.id=u.changedTouches[0].identifier,b.current.x=u.changedTouches[0].screenX,b.current.y=u.changedTouches[0].screenY)}function Y(u){u.preventDefault(),w(u.changedTouches).forEach(p=>{p.identifier==b.current.id&&B(b.current.y-p.screenY)})}function q(u){w(u.changedTouches).forEach(p=>{p.identifier==b.current.id&&(b.current.id=null,N(b.current.y-p.screenY),B(0))})}l.exports.useEffect(()=>(h.current&&(h.current.addEventListener("wheel",V,{passive:!0}),h.current.addEventListener("touchstart",$,{passive:!0}),h.current.addEventListener("touchmove",Y),h.current.addEventListener("touchend",q,{passive:!0})),()=>{!h.current||(h.current.removeEventListener("wheel",V),h.current.removeEventListener("touchstart",$),h.current.removeEventListener("touchmove",Y),h.current.removeEventListener("touchend",q))}));const W=l.exports.useMemo(()=>g?C(g.pic).map(u=>URL.createObjectURL(u)):C(),[g]);return l.exports.useEffect(()=>()=>{W.forEach(u=>URL.revokeObjectURL(u))},[]),l.exports.useEffect(()=>{document.title=(i==null?void 0:i.name)||"Scrolled Reader"},[i==null?void 0:i.name]),!i||!g?c("div",{children:c("p",{children:"Loading..."})}):z("div",{ref:h,style:{position:"relative",width:"100%",height:"100%",overflow:"hidden"},children:[c("div",{ref:_,className:"viewer",style:{position:"relative",top:(((F=h.current)==null?void 0:F.offsetHeight)||0)/2-Q-ue},children:P==null?void 0:P.map((u,p)=>ae(u,W,m=>d(f=>f&&j(T({},f),{pos:m,per:0,timestamp:Date.now()})),p+y,m=>{x=x.push(m)}))}),c(_e,{})]})}const{StrictMode:Ve,useEffect:$e}=Z;async function Ye(){return await(navigator.storage&&navigator.storage.persist&&navigator.storage.persist())}async function qe(){return await(navigator.storage&&navigator.storage.persisted&&navigator.storage.persisted())}function We(){return $e(()=>{qe().then(e=>{e||Ye()})},[]),c(Se,{children:c(ke,{children:z(Re,{children:[c(G,{path:"/",element:c(Qe,{})}),c(G,{path:"/view/:id",element:c(Ne,{})})]})})})}Ee.exports.render(c(Ve,{children:c(We,{})}),document.getElementById("root"));
