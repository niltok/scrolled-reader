var re=Object.defineProperty,se=Object.defineProperties;var ie=Object.getOwnPropertyDescriptors;var K=Object.getOwnPropertySymbols;var ce=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable;var O=(e,t,n)=>t in e?re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,N=(e,t)=>{for(var n in t||(t={}))ce.call(t,n)&&O(e,n,t[n]);if(K)for(var n of K(t))ae.call(t,n)&&O(e,n,t[n]);return e},$=(e,t)=>se(e,ie(t));var S=(e,t,n)=>(O(e,typeof t!="symbol"?t+"":t,n),n);import{L as w,D as ue,j as V,M as j,R as X,B as le,d as C,a as F,r as y,u as de,b as fe,l as pe,c as he,e as me,f as ge,g as ve,h as Q}from"./vendor.58ffcd26.js";const be=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}};be();function G(){const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}async function ye(e){return w(await Promise.all(e))}function we({path:e,root:t}){return t?"/"+e.join("/"):e.join("/")}class xe extends ue{constructor(){super("Book");S(this,"kv");S(this,"bookKeys");S(this,"books");S(this,"session");this.version(1).stores({kv:"key",bookKeys:"id",books:"id",session:"id"})}}const z=new xe,P=z.books,J=z.bookKeys,E=z.session,c=V.exports.jsx,T=V.exports.jsxs,{useState:B}=X;function W(e,t,n){const o=e.nodeName.toLowerCase(),r=s=>we({path:t.path.concat(w(s.split("/"))),root:t.root});return{label:o=="image"?"img":o,data:o=="img"?e.src:o=="a"?e.href:o=="image"?r(e.href.baseVal):void 0,content:e.childElementCount?Array.from(e.children).map(s=>W(s,t)):e.textContent?e.textContent:void 0}}function Z(e,t){return e.map(n=>{const o=n.label,r=n.href.split("#")[0].split("?")[0];return{label:o,pos:t.get(r)||0,sub:n.subitems?Z(w(n.subitems),t):void 0}}).toArray()}async function Le(e,t){return(await ye(e.map(async n=>{const o=n.href||n.url;if(o==null)return;const r={path:w(o.split("/")).pop(),root:o.length>0&&o[0]=="/"};let i=(await t.load(o)).body;for(;i.childElementCount==1&&i.firstElementChild.childElementCount;)i=i.firstElementChild;const a=Array.from(i.children).map(u=>W(u,r));return{href:o,elem:a}}))).reduce((n,o)=>{if(!o)return n;const r=n.elem.length;return{table:n.table.set(o.href,r),elem:n.elem.concat(o.elem)}},{table:j(),elem:new Array})}async function A(e,t){if(!!e)try{const n=new URL(e);return n.host==location.host?await t(n.pathname.slice(1)):e}catch(n){return console.log(n),await t(e.split("#")[0].split("?")[0])}}async function ee(e,t){let n=j();for(const o of e){if(o.label=="img"){const r=await A(o.data,async i=>i);if(!r)continue;const s=await t.archive.request(t.resolve(r),"blob");n=n.set(r,s)}typeof o.content=="object"&&(n=n.merge(await ee(o.content,t)))}return n}async function te(e,t,n){return await Promise.all(e.map(async r=>{const s=r.label=="img"?await A(r.data,async a=>a).catch(()=>r.data):r.label=="a"?await A(r.data,async a=>"pos://"+t.get(a)):void 0,i=typeof r.content=="object"?await te(r.content,t):r.content;return $(N({},r),{data:s,content:i})}))}async function q(e,t,n){const o=new le;await o.open(e,"epub"),console.log(o);const r=await o.loaded.metadata,s=await o.loaded.navigation,i=await o.loaded.spine,a=await Le(w(i.items),o),u=await te(a.elem,a.table),h=(await ee(u,o)).toObject(),U=Z(w(s.toc),a.table),L=G(),R=r.title||n;P.add({id:L,title:R,elem:u,menu:U,pic:h}),J.add({id:L,title:R}),t("Successfully imported "+R),t("Book ID: "+L)}function ke(){const e=C.exports.useLiveQuery(()=>E.toArray());return c("ul",{children:e==null?void 0:e.map((t,n)=>c("li",{children:c(F,{to:`view/${t.id}`,children:"["+Math.round(t.pos/t.size)+"%] -> "+t.name})},n))})}function Ee(){const e=C.exports.useLiveQuery(()=>J.toArray());return c("ul",{children:e==null?void 0:e.map((t,n)=>c("li",{children:c(F,{to:`view/${G()}?book=${t.id}`,children:t.title})},n))})}function Re(){const[e,t]=B(""),[n,o]=B(w()),[r,s]=B("Sessions"),i=j({Sessions:c(ke,{}),Books:c(Ee,{})}),a=u=>o(h=>h.push(u));return T("div",{children:[T("p",{children:[T("span",{children:[c("input",{type:"text",value:e,onChange:u=>t(u.target.value)}),c("button",{onClick:()=>q(e,a,e),children:"Import from URL"})]}),c("span",{children:c("input",{type:"file",accept:".epub",onChange:u=>{const h=u.target.files;h&&h.length>0&&q(URL.createObjectURL(h[0]),a,h[0].name)}})})]}),c("div",{children:n.map((u,h)=>c("p",{children:u},h))}),c("p",{children:i.keySeq().map(u=>c("button",{onClick:()=>s(u),children:u},u))}),i.get(r)]})}function ne(e,t,n,o,r){var s;return he.createElement(e.label,{key:o,ref:r,src:e.label=="img"?t.get(e.data):void 0,href:e.label=="a"?"#":void 0,onClick:e.label=="a"?i=>{i.preventDefault(),n(parseInt(e.data.slice(6)))}:void 0},typeof e.content=="string"?e.content:(s=e.content)==null?void 0:s.map((i,a)=>ne(i,t,n,a)))}function Se(){var I;const[e,t]=y.exports.useState(1),o=de().id,[r,s]=fe(),i=r.get("book"),a=C.exports.useLiveQuery(async()=>{const d=await E.get(o);if(d)return d;if(!i)return null;const f=await P.get(i);return f?(await E.put({id:o,name:f.title,size:f.elem.length,book:i,pos:0,per:0}),await E.get(o)):null},[o,i]),u=C.exports.useLiveQuery(async()=>{if(!!a)return P.get(a.book)},[a]),[h,U]=y.exports.useState(10),[L,R]=a&&u?[Math.max(0,a.pos-h),Math.min(a.pos+h,u.elem.length-1)]:[0,0],M=u?u.elem.slice(L,R+1):void 0;let x=w();const[H,oe]=y.exports.useState(0),m=y.exports.useRef(null),D=y.exports.useRef(null);function Y(d){let f=Math.max(0,H+d);for(let v=0;v<x.size-1;v++){const k=x.get(v),l=x.get(v+1);if(!k||!l)return;if(f<l.offsetTop){E.update(o,{pos:L+v,per:(f-k.offsetTop)/(l.offsetTop-k.offsetTop)});return}}const p=x.last();!p||E.update(o,{pos:L+x.size-1,per:Math.min(1,(f-p.offsetTop)/p.offsetHeight)})}const b=y.exports.useRef({id:null,x:0,y:0});y.exports.useEffect(()=>{function d(l){Y(l.deltaY)}function f(l){b.current.id||(b.current.id=l.changedTouches[0].identifier,b.current.x=l.changedTouches[0].screenX,b.current.y=l.changedTouches[0].screenY)}let p=pe.exports.throttle(l=>w(l.changedTouches).forEach(g=>{g.identifier==b.current.id&&(console.log(g.clientY,g.screenY),Y(b.current.y-g.screenY),b.current.x=g.screenX,b.current.y=g.screenY)}),30);function v(l){l.preventDefault(),p(l)}function k(l){w(l.changedTouches).forEach(g=>{g.identifier==b.current.id&&(b.current.id=null)})}return m.current&&(m.current.addEventListener("wheel",d,{passive:!0}),m.current.addEventListener("touchstart",f,{passive:!0}),m.current.addEventListener("touchmove",v),m.current.addEventListener("touchend",k,{passive:!0})),()=>{!m.current||(m.current.removeEventListener("wheel",d),m.current.removeEventListener("touchstart",f),m.current.removeEventListener("touchmove",v),m.current.removeEventListener("touchend",k))}}),y.exports.useEffect(()=>{var l;if(!a)return;const d=a.pos-L,f=((l=D.current)==null?void 0:l.offsetHeight)||0;f==0?t(g=>g+1):t(0),e==0&&f<m.current.offsetHeight&&U(g=>g+5);const p=x.get(d),v=x.get(d+1);if(!p)return;const k=p.offsetTop+a.per*(v?v.offsetTop-p.offsetTop:p.offsetHeight);oe(k)});const _=y.exports.useMemo(()=>u?j(u.pic).map(d=>URL.createObjectURL(d)):j(),[u]);return y.exports.useEffect(()=>()=>{_.forEach(d=>URL.revokeObjectURL(d))}),a===null?c("div",{children:"Bad Parameters"}):c("div",{ref:m,style:{position:"relative",width:"100%",height:"100%",overflow:"hidden"},children:c("div",{ref:D,className:"viewer",style:{position:"relative",top:(((I=m.current)==null?void 0:I.offsetHeight)||0)/2-H},children:M==null?void 0:M.map((d,f)=>ne(d,_,p=>E.update(o,{pos:p,per:0}),f,p=>{x=x.push(p)}))})})}const{StrictMode:je}=X;function Te(){return c(ge,{basename:"/",children:T(ve,{children:[c(Q,{path:"/",element:c(Re,{})}),c(Q,{path:"/view/:id",element:c(Se,{})})]})})}me.exports.render(c(je,{children:c(Te,{})}),document.getElementById("root"));
