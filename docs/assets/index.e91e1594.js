var pe=Object.defineProperty,me=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var X=Object.getOwnPropertySymbols;var ge=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var I=(e,t,n)=>t in e?pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,j=(e,t)=>{for(var n in t||(t={}))ge.call(t,n)&&I(e,n,t[n]);if(X)for(var n of X(t))ve.call(t,n)&&I(e,n,t[n]);return e},T=(e,t)=>me(e,he(t));var O=(e,t,n)=>(I(e,typeof t!="symbol"?t+"":t,n),n);import{L as v,D as we,r as l,d as E,j as J,M,R as Z,B as ye,a as ee,u as xe,b as be,c as Le,e as Ee,S as Se,f as ke,g as Re,h as G}from"./vendor.ce18ed85.js";const je=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerpolicy&&(a.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?a.credentials="include":o.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}};je();function te(){const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}async function Te(e){return v(await Promise.all(e))}function Oe({path:e,root:t}){return t?"/"+e.join("/"):e.join("/")}class Ce extends we{constructor(){super("Book");O(this,"kv");O(this,"bookKeys");O(this,"books");O(this,"session");this.version(1).stores({kv:"key",bookKeys:"id",books:"id",session:"id"})}}const b=new Ce,ne=b.books,K=b.bookKeys,C=b.session;async function Me(e){const t=await b.kv.get(e);return t==null?void 0:t.val}async function ze(e,t){await b.kv.put({key:e,val:t,timestamp:Date.now()})}const De={get:Me,set:ze};function Ue(e,t){const[n,s]=l.exports.useState(void 0),o=E.exports.useLiveQuery(()=>C.get(e),[e]);return o&&(!n||o.timestamp>n.timestamp)&&(console.log("db new session",o),s(o)),l.exports.useEffect(()=>{(async()=>{if(await C.get(e)||!t)return;const r=await K.get(t);if(!r)return null;await C.put({id:e,name:r.title,size:r.size,book:t,pos:0,per:0,timestamp:0})})()},[e,t]),l.exports.useEffect(()=>{n&&(!o||n.timestamp>o.timestamp)&&C.put(n)},[n,o]),[n,s]}const Pe=(e,t)=>{const[n,s]=l.exports.useState(t),[o,a]=l.exports.useState(0),r=E.exports.useLiveQuery(()=>b.kv.get(e),[e]);r&&r.timestamp>o&&(s(r.val),a(r.timestamp)),l.exports.useEffect(()=>{(!r||r.timestamp<o)&&b.kv.put({key:e,val:n,timestamp:o})},[e,n]);function i(p){s(typeof p=="function"?p(n):p),a(Date.now())}return[n,o,i]},c=J.exports.jsx,z=J.exports.jsxs,{useState:P}=Z;function oe(e,t,n){const s=e.nodeName.toLowerCase(),o=a=>Oe({path:t.path.concat(v(a.split("/"))),root:t.root});return{label:s=="image"?"img":s,data:s=="img"?e.src:s=="a"?e.href:s=="image"?o(e.href.baseVal):void 0,content:e.childElementCount?Array.from(e.children).map(a=>oe(a,t)):e.textContent?e.textContent:void 0}}function se(e,t){return e.map(n=>{const s=n.label,o=n.href.split("#")[0].split("?")[0];return{label:s,pos:t.get(o)||0,sub:n.subitems?se(v(n.subitems),t):void 0}}).toArray()}async function Be(e,t){return(await Te(e.map(async n=>{const s=n.href||n.url;if(s==null)return;const o={path:v(s.split("/")).pop(),root:s.length>0&&s[0]=="/"};let r=(await t.load(s)).body;for(;r.childElementCount==1&&r.firstElementChild.childElementCount;)r=r.firstElementChild;const i=Array.from(r.children).map(p=>oe(p,o));return{href:s,elem:i}}))).reduce((n,s)=>{if(!s)return n;const o=n.elem.length;return{table:n.table.set(s.href,o),elem:n.elem.concat(s.elem)}},{table:M(),elem:new Array})}async function A(e,t){if(!!e)try{const n=new URL(e);return n.host==location.host?await t(n.pathname.slice(1)):e}catch(n){return console.log(n),await t(e.split("#")[0].split("?")[0])}}async function re(e,t){let n=M();for(const s of e){if(s.label=="img"){const o=await A(s.data,async r=>r);if(!o)continue;const a=await t.archive.request(t.resolve(o),"blob");n=n.set(o,a)}typeof s.content=="object"&&(n=n.merge(await re(s.content,t)))}return n}async function ie(e,t,n){return await Promise.all(e.map(async o=>{const a=o.label=="img"?await A(o.data,async i=>i).catch(()=>o.data):o.label=="a"?await A(o.data,async i=>"pos://"+t.get(i)):void 0,r=typeof o.content=="object"?await ie(o.content,t):o.content;return T(j({},o),{data:a,content:r})}))}async function He(e,t,n){const s=new ye;await s.open(e,"epub"),console.log(s);const o=await s.loaded.metadata,a=await s.loaded.navigation,r=await s.loaded.spine,i=await Be(v(r.items),s),p=await ie(i.elem,i.table),g=(await re(p,s)).toObject(),D=se(v(a.toc),i.table),S=te(),w=o.title||n,U=p.length;ne.add({id:S,title:w,elem:p,menu:D,pic:g,size:U}),K.add({id:S,title:w,size:U}),t("Successfully imported "+w),t("Book ID: "+S)}function Ie(){const e=E.exports.useLiveQuery(()=>C.toArray());return c("ul",{children:e==null?void 0:e.map((t,n)=>c("li",{children:c(ee,{to:`view/${t.id}`,children:"[ "+Math.floor(t.pos/t.size*100*10)/10+"% ] -> "+t.name})},n))})}function Ae(){const e=E.exports.useLiveQuery(()=>K.toArray());return c("ul",{children:e==null?void 0:e.map((t,n)=>c("li",{children:c(ee,{to:`view/${te()}?book=${t.id}`,children:t.title})},n))})}function Ke(){const[e,t,n]=Pe("injection",""),[s,o]=P(""),[a,r]=P(0);return t>a&&(o(e),r(t)),z("div",{children:[c("textarea",{value:s,onChange:i=>o(i.target.value)}),c("br",{}),c("button",{onClick:()=>{r(Date.now()),n(s)},children:"Save"})]})}function Qe(){const[e,t]=P(v()),[n,s]=P("Sessions"),o=M({Sessions:c(Ie,{}),Books:c(Ae,{}),Injection:c(Ke,{})}),a=r=>t(i=>i.push(r));return z("div",{style:{margin:"100px auto",width:"90%",maxWidth:"650px"},children:[z("p",{style:{display:"flex"},children:[c("span",{children:"Import .epub: "}),c("span",{children:c("input",{title:" ",type:"file",accept:".epub",onChange:r=>{const i=r.target.files;i&&i.length>0&&He(URL.createObjectURL(i[0]),a,i[0].name)}})})]}),c("ul",{style:{fontSize:"11px"},children:e.map((r,i)=>c("li",{children:r},i))}),c("p",{children:o.keySeq().map(r=>c("button",{onClick:()=>s(r),children:r},r))}),o.get(n)]})}function _e(){const e=E.exports.useLiveQuery(()=>De.get("injection")),t=l.exports.useRef(null);return l.exports.useEffect(()=>{t.current&&e&&(t.current.innerHTML=e)},[e]),c("div",{style:{display:"none"},ref:t})}function ae(e,t,n,s,o){var a;return Le.createElement(e.label,{key:s,ref:o,src:e.label=="img"?t.get(e.data):void 0,href:e.label=="a"?"#":void 0,onClick:e.label=="a"?r=>{r.preventDefault(),n(parseInt(e.data.slice(6)))}:void 0},typeof e.content=="string"?e.content:(a=e.content)==null?void 0:a.map((r,i)=>ae(r,t,n,i)))}function Ne(){var F;const[e,t]=l.exports.useState(1),s=xe().id,[o,a]=be(),r=o.get("book"),[i,p]=Ue(s,r),g=E.exports.useLiveQuery(async()=>{if(!!i)return ne.get(i.book)},[i==null?void 0:i.book]),[D,S]=l.exports.useState(10),[w,U]=i&&g?[Math.max(0,i.pos-D),Math.min(i.pos+D,g.elem.length-1)]:[0,0],B=g?g.elem.slice(w,U+1):void 0;let y=v();const[Q,ce]=l.exports.useState(0),m=l.exports.useRef(null),_=l.exports.useRef(null),[ue,H]=l.exports.useState(0),[Fe,le]=l.exports.useState(0),[Xe,fe]=l.exports.useState(0);l.exports.useEffect(()=>{function u(){le(window.innerHeight),fe(window.innerWidth)}return window.addEventListener("resize",u),()=>{window.removeEventListener("resize",u)}});function N(u){let d=Math.max(0,Q+u);for(let f=0;f<y.size-1;f++){const k=y.get(f),L=y.get(f+1);if(!k||!L)return;if(d<L.offsetTop){p(R=>R&&T(j({},R),{pos:w+f,per:(d-k.offsetTop)/(L.offsetTop-k.offsetTop),timestamp:Date.now()}));return}}const h=y.last();!h||p(f=>f&&T(j({},f),{pos:w+y.size-1,per:Math.min(1,(d-h.offsetTop)/h.offsetHeight),timestamp:Date.now()}))}const de=()=>{var L;if(!i)return;const u=i.pos-w,d=((L=_.current)==null?void 0:L.offsetHeight)||0;if(d==0)return;t(0),e==0&&d<m.current.offsetHeight*3&&S(R=>R+5);const h=y.get(u),f=y.get(u+1);if(!h)return;const k=h.offsetTop+i.per*(f?f.offsetTop-h.offsetTop:h.offsetHeight);ce(k)};l.exports.useEffect(de);const x=l.exports.useRef({id:null,x:0,y:0});function V(u){N(u.deltaY)}function $(u){x.current.id||(H(0),x.current.id=u.changedTouches[0].identifier,x.current.x=u.changedTouches[0].screenX,x.current.y=u.changedTouches[0].screenY)}function Y(u){u.preventDefault(),v(u.changedTouches).forEach(d=>{d.identifier==x.current.id&&H(x.current.y-d.screenY)})}function q(u){v(u.changedTouches).forEach(d=>{d.identifier==x.current.id&&(x.current.id=null,N(x.current.y-d.screenY),H(0))})}l.exports.useEffect(()=>(m.current&&(m.current.addEventListener("wheel",V,{passive:!0}),m.current.addEventListener("touchstart",$,{passive:!0}),m.current.addEventListener("touchmove",Y),m.current.addEventListener("touchend",q,{passive:!0})),()=>{!m.current||(m.current.removeEventListener("wheel",V),m.current.removeEventListener("touchstart",$),m.current.removeEventListener("touchmove",Y),m.current.removeEventListener("touchend",q))}));const W=l.exports.useMemo(()=>g?M(g.pic).map(u=>URL.createObjectURL(u)):M(),[g]);return l.exports.useEffect(()=>()=>{W.forEach(u=>URL.revokeObjectURL(u))},[]),l.exports.useEffect(()=>{document.title=(i==null?void 0:i.name)||"Scrolled Reader"},[i==null?void 0:i.name]),!i||!g?c("div",{children:c("p",{children:"Loading..."})}):z("div",{ref:m,style:{position:"relative",width:"100%",height:"100%",overflow:"hidden"},children:[c("div",{ref:_,className:"viewer",style:{position:"relative",top:(((F=m.current)==null?void 0:F.offsetHeight)||0)/2-Q-ue},children:B==null?void 0:B.map((u,d)=>ae(u,W,h=>p(f=>f&&T(j({},f),{pos:h,per:0,timestamp:Date.now()})),d+w,h=>{y=y.push(h)}))}),c(_e,{})]})}const{StrictMode:Ve,useEffect:$e}=Z;async function Ye(){return await(navigator.storage&&navigator.storage.persist&&navigator.storage.persist())}async function qe(){return await(navigator.storage&&navigator.storage.persisted&&navigator.storage.persisted())}function We(){return $e(()=>{qe().then(e=>{e||Ye()})},[]),c(Se,{children:c(ke,{basename:"/",children:z(Re,{children:[c(G,{path:"/",element:c(Qe,{})}),c(G,{path:"/view/:id",element:c(Ne,{})})]})})})}Ee.exports.render(c(Ve,{children:c(We,{})}),document.getElementById("root"));
